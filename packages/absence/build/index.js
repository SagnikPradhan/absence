"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("uWebSockets.js"),e=require("http");function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var n,i=r(t);!function(t){t[t.ROOT=0]="ROOT",t[t.STATIC=1]="STATIC",t[t.PARAMETER=2]="PARAMETER",t[t.CATCH_ALL=3]="CATCH_ALL"}(n||(n={}));class l{root={type:n.ROOT,path:"/",data:null,priority:0,childIndex:"",childValues:[],childWild:null};add(t,e,r=this.root){const i=this.findCommonPrefixLength(t,r.path);if(i<r.path.length){const t={path:r.path.slice(i),type:r.type,data:r.data,priority:r.priority,childIndex:r.childIndex,childValues:r.childValues,childWild:r.childWild};r.type=n.STATIC,r.data=null,r.childIndex=r.path[i],r.path=r.path.slice(0,i),r.priority+=1,r.childValues=[t],r.childWild=null}if(i<t.length){const n=(t=t.slice(i))[0];for(let i=0;i<r.childIndex.length;i++)if(n===r.childIndex[i])return r.priority+=1,this.add(t,e,r.childValues[i]),void this.sortOnPriorityFrom(i,r);return r.priority+=1,this.insertInNode(r,t,e)}if(null!==r.data)throw new Error("Found duplicate routes");r.data=e}sortOnPriorityFrom(t,e){const r=e.childValues,n=e.childIndex,i=r[t].priority;let l=t;for(;l>0&&r[l-1].priority<i;)[r[l],r[l-1]]=[r[l-1],r[l]],l--;l!==t&&(e.childIndex=n.slice(0,l)+n[t]+n.slice(l,t)+n.slice(t+1))}findCommonPrefixLength(t,e){const r=Math.min(t.length,e.length);let n=0;for(;n<r&&t[n]===e[n];)n++;return n}insertInNode(t,e,r){const i=this.findWildCard(e);if(i.startIndex>-1){const l=e.slice(i.startIndex,i.endIndex+1),a=":"===l[0]?n.PARAMETER:n.CATCH_ALL;if(i.startIndex>0){const r={type:n.STATIC,path:e.slice(0,i.startIndex),data:null,priority:1,childIndex:"",childValues:[],childWild:null};t.childIndex+=e[0],t.childValues.push(r),t=r}if(t.childWild){if(t.childWild.path!==l){const e=l.slice(0,-1),r=t.childWild.path.slice(0,-1);throw new Error(`Found duplicate parameters at same position - ${e}, ${r}`)}}else t.childWild={path:l,type:a,data:null,priority:0,childIndex:"",childValues:[],childWild:null};if(i.endIndex+1<e.length){if(a===n.PARAMETER)return this.add(e.slice(i.startIndex),r,t.childWild);throw new Error("Found path after catch all parameter")}t.childWild.data=r}else t.childIndex+=e[0],t.childValues.push({type:n.STATIC,path:e,data:r,priority:0,childIndex:"",childValues:[],childWild:null})}findWildCard(t){let e=-1,r=t.length-1,i=null;for(let l=0;l<t.length;l++){if(":"===t[l]){if(e>-1)throw new Error("Found multiple parameters in same segment");e=l,i=n.PARAMETER}if("*"===t[l]){if(e>-1)throw new Error("Found multiple parameters in same segment");e=l,i=n.CATCH_ALL}if("/"===t[l]&&e>-1){r=l;break}}return{startIndex:e,endIndex:r,type:i}}lookup(t){let e=this.root,r=null;const i={};t:for(;;){if(t.length>e.path.length){if(t.slice(0,e.path.length)===e.path){const r=(t=t.slice(e.path.length))[0],l=e.childIndex;for(let t=0;t<l.length;t++)if(r===l[t]){e=e.childValues[t];continue t}if(e.childWild)switch(e=e.childWild,e.type){case n.PARAMETER:let r=0;for(;r<t.length&&"/"!==t[r];)r++;if(i[e.path.slice(1,-1)]=t.slice(0,r),t.length>r+1){if(e.childValues.length>0){const n=(t=t.slice(r+1))[0],i=e.childIndex;for(let t=0;t<i.length;t++)if(n===i[t]){e=e.childValues[t];continue t}}return null}return e.data?{data:e.data,parameters:i}:null;case n.CATCH_ALL:return i[e.path.slice(1,-1)]=t,{data:e.data,parameters:i}}}}else t===e.path&&(r=e.data);return r?{data:r,parameters:i}:null}}}const a=/\/+|(?<!\/)($|^)/g;function s(t){return t.replace(a,"/")}async function d(t,e){const r=s(e.getUrl()),n=e.getMethod(),i=function(t){return Object.fromEntries(new URLSearchParams(t.getQuery()).entries())}(e),l=function(t){const e={};return t.forEach(((t,r)=>e[t]=r)),e}(e),a=await function(t){return new Promise((e=>{const r=[];t.onData(((t,n)=>{r.push(Buffer.from(t)),n&&e(Buffer.concat(r).toString())}))}))}(t);return{path:r,method:n,queries:i,headers:l,body:a}}function o(t){console.error(t),"production"===process.env.NODE_ENV&&process.exit(1)}exports.createServer=function(){const t=[],r=[],n={};let a=null;return{use(t){return r.push(t),this},route(t){const e="object"==typeof t?t:{path:t,method:"all"},r=[];return{use(t){return r.push(t),this},handle(t){n[e.method]||(n[e.method]=new l),n[e.method].add(s(e.path),{plugins:r,handler:t,...e})}}},useErrorHandler(t){return a=t,this},listen:l=>new Promise(((s,c)=>{const h=i.App();h.any("/*",(async(t,i)=>{const l=function(t){const r={aborted:!1};t.onAborted((()=>r.aborted=!0));const n={headers:{},body:"",status:`418 ${e.STATUS_CODES[418]}`};return{setHeader(t,e){return n.headers[t]=e,this},setStatus(t,r=e.STATUS_CODES[t]){return n.status=`${t} ${r}`,this},send(e){e&&(n.body=e),r.aborted||t.cork((()=>{for(const e in n.headers)t.writeHeader(e,n.headers[e]);t.writeStatus(n.status),t.end(n.body)}))}}}(t),s=await d(t,i),c=n[s.method]?.lookup(s.path)||n.all?.lookup(s.path);if(!c)return l.setStatus(404).send();const h={request:{...s,parameters:c.parameters},response:l};for(const t of[...r,...c.data.plugins])if(t.initialize){const e=await t.initialize();e&&(h[t.name]=e)}c.data.handler(h).catch((t=>function(t,e){e&&e.setStatus(500).send(),a?a(t).catch(o):o(t)}(t,l)))})),h.listen(l,1,(e=>{e?(t.push(e),s(i.us_socket_local_port(e))):c(new Error(`Could not connect to ${l}`))}))})),stop(){for(const e of t)i.us_listen_socket_close(e);t.length=0}}};
//# sourceMappingURL=index.js.map
