import*as t from"uWebSockets.js";import{STATUS_CODES as e}from"http";var n;!function(t){t[t.ROOT=0]="ROOT",t[t.STATIC=1]="STATIC",t[t.PARAMETER=2]="PARAMETER",t[t.CATCH_ALL=3]="CATCH_ALL"}(n||(n={}));class i{root={type:n.ROOT,path:"/",data:null,priority:0,childIndex:"",childValues:[],childWild:null};add(t,e,i=this.root){const r=this.findCommonPrefixLength(t,i.path);if(r<i.path.length){const t={path:i.path.slice(r),type:i.type,data:i.data,priority:i.priority,childIndex:i.childIndex,childValues:i.childValues,childWild:i.childWild};i.type=n.STATIC,i.data=null,i.childIndex=i.path[r],i.path=i.path.slice(0,r),i.priority+=1,i.childValues=[t],i.childWild=null}if(r<t.length){const n=(t=t.slice(r))[0];for(let r=0;r<i.childIndex.length;r++)if(n===i.childIndex[r])return i.priority+=1,this.add(t,e,i.childValues[r]),void this.sortOnPriorityFrom(r,i);return i.priority+=1,this.insertInNode(i,t,e)}if(null!==i.data)throw new Error("Found duplicate routes");i.data=e}sortOnPriorityFrom(t,e){const n=e.childValues,i=e.childIndex,r=n[t].priority;let l=t;for(;l>0&&n[l-1].priority<r;)[n[l],n[l-1]]=[n[l-1],n[l]],l--;l!==t&&(e.childIndex=i.slice(0,l)+i[t]+i.slice(l,t)+i.slice(t+1))}findCommonPrefixLength(t,e){const n=Math.min(t.length,e.length);let i=0;for(;i<n&&t[i]===e[i];)i++;return i}insertInNode(t,e,i){const r=this.findWildCard(e);if(r.startIndex>-1){const l=e.slice(r.startIndex,r.endIndex+1),a=":"===l[0]?n.PARAMETER:n.CATCH_ALL;if(r.startIndex>0){const i={type:n.STATIC,path:e.slice(0,r.startIndex),data:null,priority:1,childIndex:"",childValues:[],childWild:null};t.childIndex+=e[0],t.childValues.push(i),t=i}if(t.childWild){if(t.childWild.path!==l){const e=l.slice(0,-1),n=t.childWild.path.slice(0,-1);throw new Error(`Found duplicate parameters at same position - ${e}, ${n}`)}}else t.childWild={path:l,type:a,data:null,priority:0,childIndex:"",childValues:[],childWild:null};if(r.endIndex+1<e.length){if(a===n.PARAMETER)return this.add(e.slice(r.startIndex),i,t.childWild);throw new Error("Found path after catch all parameter")}t.childWild.data=i}else t.childIndex+=e[0],t.childValues.push({type:n.STATIC,path:e,data:i,priority:0,childIndex:"",childValues:[],childWild:null})}findWildCard(t){let e=-1,i=t.length-1,r=null;for(let l=0;l<t.length;l++){if(":"===t[l]){if(e>-1)throw new Error("Found multiple parameters in same segment");e=l,r=n.PARAMETER}if("*"===t[l]){if(e>-1)throw new Error("Found multiple parameters in same segment");e=l,r=n.CATCH_ALL}if("/"===t[l]&&e>-1){i=l;break}}return{startIndex:e,endIndex:i,type:r}}lookup(t){let e=this.root,i=null;const r={};t:for(;;){if(t.length>e.path.length){if(t.slice(0,e.path.length)===e.path){const i=(t=t.slice(e.path.length))[0],l=e.childIndex;for(let t=0;t<l.length;t++)if(i===l[t]){e=e.childValues[t];continue t}if(e.childWild)switch(e=e.childWild,e.type){case n.PARAMETER:let i=0;for(;i<t.length&&"/"!==t[i];)i++;if(r[e.path.slice(1,-1)]=t.slice(0,i),t.length>i+1){if(e.childValues.length>0){const n=(t=t.slice(i+1))[0],r=e.childIndex;for(let t=0;t<r.length;t++)if(n===r[t]){e=e.childValues[t];continue t}}return null}return e.data?{data:e.data,parameters:r}:null;case n.CATCH_ALL:return r[e.path.slice(1,-1)]=t,{data:e.data,parameters:r}}}}else t===e.path&&(i=e.data);return i?{data:i,parameters:r}:null}}}const r=/\/+|(?<!\/)($|^)/g;function l(t){return t.replace(r,"/")}async function a(t,e){const n=l(e.getUrl()),i=e.getMethod(),r=function(t){return Object.fromEntries(new URLSearchParams(t.getQuery()).entries())}(e),a=function(t){const e={};return t.forEach(((t,n)=>e[t]=n)),e}(e),s=await function(t){return new Promise((e=>{const n=[];t.onData(((t,i)=>{n.push(Buffer.from(t)),i&&e(Buffer.concat(n).toString())}))}))}(t);return{path:n,method:i,queries:r,headers:a,body:s}}function s(t){console.error(t),"production"===process.env.NODE_ENV&&process.exit(1)}function d(){const n=[],r=[],d={};let o=null;return{use(t){return r.push(t),this},route(t){const e="object"==typeof t?t:{path:t,method:"all"},n=[];return{use(t){return n.push(t),this},handle(t){d[e.method]||(d[e.method]=new i),d[e.method].add(l(e.path),{plugins:n,handler:t,...e})}}},useErrorHandler(t){return o=t,this},listen:i=>new Promise(((l,h)=>{const c=t.App();c.any("/*",(async(t,n)=>{const i=function(t){const n={aborted:!1};t.onAborted((()=>n.aborted=!0));const i={headers:{},body:"",status:`418 ${e[418]}`};return{setHeader(t,e){return i.headers[t]=e,this},setStatus(t,n=e[t]){return i.status=`${t} ${n}`,this},send(e){e&&(i.body=e),n.aborted||t.cork((()=>{for(const e in i.headers)t.writeHeader(e,i.headers[e]);t.writeStatus(i.status),t.end(i.body)}))}}}(t),l=await a(t,n),h=d[l.method]?.lookup(l.path)||d.all?.lookup(l.path);if(!h)return i.setStatus(404).send();const c={request:{...l,parameters:h.parameters},response:i};for(const t of[...r,...h.data.plugins])if(t.initialize){const e=await t.initialize();e&&(c[t.name]=e)}h.data.handler(c).catch((t=>function(t,e){e&&e.setStatus(500).send(),o?o(t).catch(s):s(t)}(t,i)))})),c.listen(i,1,(e=>{e?(n.push(e),l(t.us_socket_local_port(e))):h(new Error(`Could not connect to ${i}`))}))})),stop(){for(const e of n)t.us_listen_socket_close(e);n.length=0}}}export{d as createServer};
//# sourceMappingURL=index.mjs.map
